name: Natural Daily Contributions (Smart)

on:
  schedule:
    - cron: "0 5 * * *" # 1:00 PM PH Time
  workflow_dispatch:

jobs:
  contribute:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      GIT_AUTHOR_NAME: "JoeyCollado"
      GIT_COMMITTER_NAME: "JoeyCollado"
      GIT_AUTHOR_EMAIL: "144526580+JoeyCollado@users.noreply.github.com"
      GIT_COMMITTER_EMAIL: "144526580+JoeyCollado@users.noreply.github.com"
      TZ: "Asia/Manila"

    steps:
      - uses: actions/checkout@v4

      - name: Smart Contribution System
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          mkdir work
          cd work

          echo "===== SMART CONTRIBUTION SYSTEM STARTED ====="

          # Automatically fetch all public repos you own
          echo "Fetching repos from GitHub API..."
          curl -s -H "Authorization: token ${TOKEN}" \
            "https://api.github.com/users/JoeyCollado/repos?per_page=200" \
            | jq -r '.[].full_name' > repos.txt

          # Optional: add private repos manually if needed
          echo "JoeyCollado/private-repo-example" >> repos.txt

          msgs=(
            "docs: routine maintenance update"
            "chore: daily sync"
            "style: formatting improvements"
            "refactor: tiny cleanup"
            "perf: micro optimizations"
            "chore: update system metadata"
            "docs: auto-update"
          )

          files=(
            "README.md"
            ".keepalive"
            ".github/commit.log"
          )

          TOTAL=$((RANDOM % 6 + 10))
          echo "Target commits today: $TOTAL"
          echo ""

          success=0
          failed=0

          for i in $(seq 1 $TOTAL); do
            echo "======== Commit #$i ========"

            repo=$(shuf -n 1 repos.txt)
            echo "Selected repo: $repo"

            # ------ SMART CLONE CHECK ------
            if ! git clone "https://x-access-token:${TOKEN}@github.com/$repo.git" "$i-repo" 2>/dev/null; then
              echo "‚ùå Clone failed ‚Äî repo is protected or unavailable"
              failed=$((failed+1))
              echo ""
              continue
            fi

            cd "$i-repo"

            git config user.name "$GIT_AUTHOR_NAME"
            git config user.email "$GIT_AUTHOR_EMAIL"
            git config --global --add safe.directory "$(pwd)"

            target=${files[$RANDOM % ${#files[@]}]}
            mkdir -p "$(dirname "$target")"
            touch "$target"

            echo "- update on $(date '+%Y-%m-%d %H:%M:%S')" >> "$target"

            git add "$target"

            msg=${msgs[$RANDOM % ${#msgs[@]}]}

            # ------ SMART COMMIT CHECK ------
            if ! git commit -m "$msg" >/dev/null 2>&1; then
              echo "‚ö† No changes to commit ‚Äî skipping"
              cd ..
              rm -rf "$i-repo"
              failed=$((failed+1))
              echo ""
              continue
            fi

            # ------ SMART PUSH CHECK ------
            if git push >/dev/null 2>&1; then
              echo "‚úî Commit pushed successfully"
              success=$((success+1))
            else
              echo "‚ùå Push denied ‚Äî repo is protected"
              failed=$((failed+1))
            fi

            cd ..
            rm -rf "$i-repo"

            delay=$((RANDOM % 60 + 40))
            echo "Sleeping for $delay seconds..."
            sleep $delay
            echo ""
          done

          echo "===== SUMMARY ====="
          echo "Successful commits: $success"
          echo "Failed/skipped: $failed"
          echo "===================="

          echo "üéâ Smart system finished!"
